<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>OderoPOS developer docs</title>

    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sa {
  color: #6c71c4;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <style>
      .highlight pre, pre[class*="language-"] {
        background-color: #000000 !important;
        color: #ffffff !important;
        font-size: 12px !important;
        line-height: 1.4 !important;
      }
      
      .highlight .n, .token.plain {
        color: #d4d4d4 !important;
      }
      
      .highlight .s1, .token.string {
        color: #ce9178 !important;
      }
      
      .highlight .k, .token.keyword {
        color: #569cd6 !important;
      }
      
      .highlight .o, .token.operator {
        color: #d4d4d4 !important;
      }
      
      .highlight .c1, .token.comment {
        color: #6a9955 !important;
      }
      
      .highlight .kd, .token.keyword {
        color: #569cd6 !important;
      }
      
      .highlight .nc, .token.class-name {
        color: #4ec9b0 !important;
      }
      
      /* Kotlin specific styles */
      .language-kotlin {
        background-color: #000000 !important;
        color: #d4d4d4 !important;
      }
      
      .language-kotlin .keyword {
        color: #569cd6 !important;
      }
      
      .language-kotlin .string {
        color: #ce9178 !important;
      }
      
      .language-kotlin .function {
        color: #dcdcaa !important;
      }
      
      .language-kotlin .comment {
        color: #6a9955 !important;
      }
    </style>
    <link href="stylesheets/screen-9c19b03a.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-966d6edc.css" rel="stylesheet" media="print" />
    <link href="stylesheets/prism.css" rel="stylesheet">
      <script src="javascripts/all-b12a2749.js"></script>
      <!-- CDN option if you don't have the local file -->
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>  
      <!-- Add Prism.js language components -->
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-kotlin.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-swift.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-objectivec.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-ruby.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-groovy.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-shell-session.min.js"></script>

    <script>
      $(function() { 
        setupCodeCopy(); 
        // Initialize Prism.js after page load
        if (typeof Prism !== 'undefined') {
          Prism.highlightAll();
        }
      });
    </script>
  </head>

  <body class="index" data-languages="[]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-cc102dc1.png" class="logo" alt="" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#app-integration" class="toc-h1 toc-link" data-title="App integration">App integration</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#launcher" class="toc-h2 toc-link" data-title="Launcher">Launcher</a>
                  </li>
                  <li>
                    <a href="#paymentgateway" class="toc-h2 toc-link" data-title="PaymentGateway">PaymentGateway</a>
                  </li>
                  <li>
                    <a href="#printer-app" class="toc-h2 toc-link" data-title="Printer App">Printer App</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#opit" class="toc-h1 toc-link" data-title="OPIT">OPIT</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#introduction" class="toc-h2 toc-link" data-title="Introduction">Introduction</a>
                  </li>
                  <li>
                    <a href="#opit-setup" class="toc-h2 toc-link" data-title="Setup">Setup</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#ecr-integration" class="toc-h1 toc-link" data-title="ECR integration">ECR integration</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#app-setup" class="toc-h2 toc-link" data-title="App Setup">App Setup</a>
                  </li>
                  <li>
                    <a href="#fiscal-commands" class="toc-h2 toc-link" data-title="Fiscal commands">Fiscal commands</a>
                  </li>
                  <li>
                    <a href="#sending-a-card-payment" class="toc-h2 toc-link" data-title="Sending a card payment">Sending a card payment</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#in-app-payments" class="toc-h1 toc-link" data-title="In App Payments">In App Payments</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#sdk-setup" class="toc-h2 toc-link" data-title="SDK Setup">SDK Setup</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://github.com/slatedocs/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='app-integration'>App integration</h1>
<p>Here&#39;s everything you require for integrating with the OderoPOS Android system, enabling your application to seamlessly interact with our devices for card payments and printing via a set of clearly defined APIs. Our tools simplify the integration process, ensuring ease and speed while minimizing the need for future adjustments on your end. OderoPOS, integrated into the Android system, is continuously maintained and updated, forming our robust ecosystem.</p>
<h2 id='launcher'>Launcher</h2>
<p>In order to be recognized by Token Platform and be visible in the Launcher, please also add the following lines to <code>AndroidManifest.xml</code> file.</p>

<blockquote>
<p>AndroidManifest.xml</p>
</blockquote>
<div class="highlight"><pre class="highlight xml tab-xml"><code><span class="nt">&lt;application&gt;</span>
    <span class="c">&lt;!-- Other fields --&gt;</span>
    <span class="c">&lt;!-- App Name should be started with LYL, thus Launcher can differentiate sale apps --&gt;</span>
    <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"app_name"</span> <span class="na">android:value=</span><span class="s">"LYL_APP_NAME"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"app_model_type"</span> <span class="na">android:value=</span><span class="s">"400TR"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"app_version"</span> <span class="na">android:value=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"sale_activity_name"</span> <span class="na">android:value=</span><span class="s">"&lt;internal_packages&gt;.&lt;activity_name&gt;"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/application&gt;</span>
</code></pre></div>
<p>Please ensure that <code>sale_activity_name</code> is the Activity that will be shown to the customers as the first screen.</p>
<div class="highlight"><pre class="highlight xml tab-xml"><code><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">".activity.MyActivity"</span>
            <span class="na">android:exported=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/activity&gt;</span>
<span class="c">&lt;!-- Example Usage --&gt;</span>
    <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"sale_activity_name"</span> <span class="na">android:value=</span><span class="s">".android.MyActivity"</span> <span class="nt">/&gt;</span>
</code></pre></div><h2 id='paymentgateway'>PaymentGateway</h2>
<p>Allows payment requests in a uniform way across all POS family.</p>

<p>The API is agnostic of the underlying payment procedures, which may involve banking, card reading, etc.</p>

<p>The PGW will take care of all the printing during a payment request. The caller does not need to handle it via the printer app.</p>

<p><img src="images/317915137-64b691c7.png" alt="!\[alt text\](Architecture)" /></p>
<h3 id='setup'>Setup</h3>
<p>In order to access the PGW app, the following pgw-launcher and common library should be included in the app. To do this add the following maven url to <code>settings.gradle</code> under dependencyResolutionManagement/repositories:</p>

<blockquote>
<p>settings.gradle</p>
</blockquote>
<div class="highlight"><pre class="highlight gradle tab-gradle"><code><span class="n">maven</span> <span class="o">{</span>
    <span class="n">url</span> <span class="s1">'https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/'</span>
<span class="o">}</span>
</code></pre></div>
<p>And also in <code>app/build.gradle</code> the actual dependency should be added: <code>implementation &#39;PaymentGateway:pgw-launcher:1.0.9&#39;</code></p>

<blockquote>
<p>build.gradle</p>
</blockquote>
<div class="highlight"><pre class="highlight gradle tab-gradle"><code><span class="k">dependencies</span> <span class="o">{</span>
<span class="n">implementation</span> <span class="s1">'PaymentGateway:pgw-launcher:1.0.9'</span>
<span class="o">}</span>
</code></pre></div><h3 id='request-payment'>Request payment</h3>
<p>The payment request is done via an ActivityResultLauncher contract.</p>

<blockquote>
<p>Obtaining the PGW contract</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="kd">val</span> <span class="py">paymentResultContract</span> <span class="p">=</span> <span class="nc">PGWLauncher</span><span class="p">.</span><span class="nf">getPGWContract</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>Returns null if the PGW app is not installed on the device.</p>

<p>Payment request</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="k">import</span> <span class="nn">ro.odero.paymentgateway.common.data.CurrencyCode</span>
<span class="k">import</span> <span class="nn">ro.odero.paymentgateway.common.data.PaymentOption</span>
<span class="k">import</span> <span class="nn">ro.odero.paymentgateway.common.data.request.PaymentRequest</span>
<span class="k">import</span> <span class="nn">ro.odero.paymentgateway.launcher.PGWLauncher</span>

<span class="kd">val</span> <span class="py">pgwContract</span> <span class="p">=</span> <span class="nc">PGWLauncher</span><span class="p">.</span><span class="nf">getPGWContract</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">pgwContract</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>

<span class="kd">val</span> <span class="py">paymentLauncher</span> <span class="p">=</span> <span class="nf">registerForActivityResult</span><span class="p">(</span><span class="n">pgwContract</span><span class="p">)</span> <span class="p">{</span>
<span class="n">paymentResponse</span> <span class="p">:</span> <span class="nc">PaymentResponse</span> <span class="p">-&gt;</span>
<span class="c1">//payment response</span>
<span class="p">}</span>

<span class="n">paymentLauncher</span><span class="p">.</span><span class="nf">launch</span><span class="p">(</span><span class="nc">PaymentRequest</span><span class="p">(</span>
                <span class="n">amount</span> <span class="p">=</span> <span class="mi">12345</span><span class="p">,</span>
                <span class="n">paymentOptions</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="nc">PaymentOption</span><span class="p">.</span><span class="nc">Card</span><span class="p">),</span>
                <span class="n">currencyCode</span> <span class="p">=</span> <span class="nc">CurrencyCode</span><span class="p">.</span><span class="nc">RON</span>
            <span class="p">))</span>
</code></pre></div>
<p>According to the selected payment options <code>PGW</code> will handle the payment and printing. The amount will be internally translated as amount/100 to cover the currency decimal; in this case 12345 will internally converted to 123,45</p>
<h3 id='handling-paymentresponse'>Handling PaymentResponse</h3>
<p>Check the PaymentResponse based on the payment options sent.</p>

<blockquote>
<p>PaymentResponse handling</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="n">paymentResponse</span> <span class="p">:</span> <span class="nc">PaymentResponse</span> <span class="p">-&gt;</span>

<span class="k">if</span><span class="p">(</span><span class="n">paymentResponse</span> <span class="k">is</span> <span class="nc">CardPaymentResponse</span><span class="p">)</span><span class="o">..</span><span class="p">.</span>

<span class="k">if</span><span class="p">(</span><span class="n">paymentResponse</span> <span class="k">is</span> <span class="nc">CashPaymentResponse</span><span class="p">)</span><span class="o">..</span><span class="p">.</span>

</code></pre></div>
<blockquote>
<p>Types of PaymentResponse</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="k">sealed</span> <span class="kd">class</span> <span class="nc">CardPaymentResponse</span> <span class="p">:</span> <span class="nc">PaymentResponse</span> <span class="p">{</span>

    <span class="kd">data class</span> <span class="nc">Success</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">receiptNumber</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">bankActivityResultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">bankStatus</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">customerSlip</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">merchantSlip</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">:</span> <span class="nc">CardPaymentResponse</span><span class="p">()</span>

    <span class="kd">data class</span> <span class="nc">Fail</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">receiptNumber</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">bankActivityResultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">bankStatus</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">message</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">:</span> <span class="nc">CardPaymentResponse</span><span class="p">()</span>
<span class="p">}</span>


<span class="k">sealed</span> <span class="kd">class</span> <span class="nc">CashPaymentResponse</span> <span class="p">:</span> <span class="nc">PaymentResponse</span> <span class="p">{</span>

    <span class="kd">data class</span> <span class="nc">Success</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">receiptNumber</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">:</span> <span class="nc">CashPaymentResponse</span><span class="p">()</span>

    <span class="kd">data class</span> <span class="nc">Fail</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">receiptNumber</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">message</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">:</span> <span class="nc">CashPaymentResponse</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><h2 id='printer-app'>Printer App</h2>
<p>Allows printing in a uniform way across all POS family.</p>

<p>The API is agnostic of the underlying hardware but provides a set of well defined PrintCommands.</p>

<p><img src="images/317947907-a4f4b285.png" alt="alt text" /></p>
<h3 id='setup-2'>Setup</h3>
<p>In order to access the Printer App, the following <code>printer-launcher</code> and <code>common</code> library should be included in the app. To do this add the following code into <code>settings.gradle</code> under dependencyResolutionManagement/repositories:</p>

<blockquote>
<p>settings.gradle</p>
</blockquote>
<div class="highlight"><pre class="highlight gradle tab-gradle"><code><span class="n">maven</span> <span class="o">{</span>
    <span class="n">url</span> <span class="s1">'https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/'</span>
<span class="o">}</span>
</code></pre></div>
<p>Add in <code>build.gradle</code> the lib dependencies: <code>implementation &#39;PrinterApp:printer-launcher:1.0.3&#39;</code>
 (the pgw-launcher should also add the common lib, if not please add the dependency <code>implementation &#39;PrinterApp:common:1.0.3&#39;</code>)</p>

<blockquote>
<p>build.gradle</p>
</blockquote>
<div class="highlight"><pre class="highlight gradle tab-gradle"><code><span class="k">dependencies</span><span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">'PrinterApp:printer-launcher:1.0.3'</span>
<span class="o">}</span>
</code></pre></div><h3 id='printing'>Printing</h3>
<p>There are two distinct flows that have to be implemented</p>

<ul>
<li>Checking if printer is ready to print

<ul>
<li>The check includes also if paper is present</li>
</ul></li>
</ul>

<blockquote>
<p>When printer is ready print the receipts</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="kd">val</span> <span class="py">printerErrorCheck</span> <span class="p">=</span> <span class="nf">registerForActivityResul</span><span class="p">(</span><span class="nc">PrinterHealthResultContract</span><span class="p">()){</span>
<span class="n">printerHealth</span><span class="p">:</span> <span class="nc">PrinterHealthResponse</span><span class="p">?</span> <span class="p">-&gt;</span>

<span class="k">if</span><span class="p">(</span><span class="n">printerHealth</span><span class="p">.</span><span class="n">hasErrors</span><span class="p">.</span><span class="nf">not</span><span class="p">()){</span>
<span class="nf">printReceipts</span><span class="p">()</span>
<span class="p">}</span><span class="k">else</span>
<span class="p">{</span>
    <span class="c1">//treat the error</span>
<span class="p">}</span>

<span class="p">}</span>


</code></pre></div>
<ul>
<li>Actual printing</li>
</ul>

<blockquote>
<p>Actual printing contract that is used to start the PrinterApp</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="kd">val</span> <span class="py">printerLauncher</span> <span class="p">=</span> <span class="nf">registerForActivityResult</span><span class="p">(</span><span class="nc">PrinterResultContract</span><span class="p">())</span> <span class="p">{</span>
<span class="n">printerResponse</span><span class="p">:</span> <span class="nc">PrinterResponse</span><span class="p">?</span> <span class="p">-&gt;</span>
<span class="c1">//treat printer response</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Receipts example</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code> <span class="kd">val</span> <span class="py">customerReceipt</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintImage</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">true</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Test SRL"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">false</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Data:10.03.2023"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Ora:10:00"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Right</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"TID:0 MID:0"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"AID:00000"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Right</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"0000000000"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Small</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"BATCH:000001"</span><span class="p">,</span> <span class="s">"BON:000001"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"RRN:00123456789"</span><span class="p">,</span> <span class="s">"RC: 00"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"AUTH:775040"</span><span class="p">,</span> <span class="s">"STAN:012345"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintLine</span><span class="p">,</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">true</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Large</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"SUMA:"</span><span class="p">,</span> <span class="s">"50"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">false</span><span class="p">),</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span><span class="s">"APPROVED"</span><span class="p">,</span> <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Medium</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span><span class="s">"EXEMPLAR CLIENT"</span><span class="p">,</span> <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintLine</span><span class="p">,</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="kd">val</span> <span class="py">merchantReceipt</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintImage</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">true</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Test SRL"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">false</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Data:10.03.2023"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"Ora:10:00"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Right</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"TID:0 MID:0"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Center</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"AID:00000"</span><span class="p">,</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Right</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span>
            <span class="s">"0000000000"</span><span class="p">,</span> <span class="c1">// cardno</span>
            <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Small</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"BATCH:000001"</span><span class="p">,</span> <span class="s">"BON:000001"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"RRN:00123456789"</span><span class="p">,</span> <span class="s">"RC: 00"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"AUTH:775040"</span><span class="p">,</span> <span class="s">"STAN:012345"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintLine</span><span class="p">,</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">true</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Large</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintColumns</span><span class="p">(</span><span class="nf">arrayOf</span><span class="p">(</span><span class="s">"SUMA:"</span><span class="p">,</span> <span class="s">"50"</span><span class="p">)),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintWithBold</span><span class="p">(</span><span class="k">false</span><span class="p">),</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span><span class="s">"APPROVED"</span><span class="p">,</span> <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Left</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintFontSize</span><span class="p">(</span><span class="nc">FontSize</span><span class="p">.</span><span class="nc">Medium</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintText</span><span class="p">(</span><span class="s">"EXEMPLAR VANZATOR"</span><span class="p">,</span> <span class="nc">TextAlignment</span><span class="p">.</span><span class="nc">Center</span><span class="p">),</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintLine</span><span class="p">,</span> <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
        <span class="nc">PrintCommand</span><span class="p">.</span><span class="nc">PrintSpace</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<blockquote>
<p>Printing</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="k">fun</span> <span class="nf">printReceipts</span><span class="p">(){</span>

<span class="n">printerLauncher</span><span class="p">.</span><span class="nf">launch</span><span class="p">(</span>
            <span class="nc">PrinterRequest</span><span class="p">(</span>
                <span class="nf">listOf</span><span class="p">(</span>
                    <span class="nc">PrintDocument</span><span class="p">(</span>
                        <span class="n">clientReceipt</span><span class="p">,</span>
                        <span class="s">"Chitanta client"</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="nc">PrintDocument</span><span class="p">(</span><span class="n">merchantReceipt</span><span class="p">,</span> <span class="s">"Chitanta vanzator"</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="nc">PrintRequestType</span><span class="p">.</span><span class="nc">PrintWithDialog</span><span class="p">,</span> <span class="c1">// will show a dialog between each print</span>
                <span class="c1">// document</span>
                <span class="c1">// PrintRequestType.SimplePrint //will print each document back-to-back - useful</span>
                <span class="c1">// for setlements, reports, etc</span>
            <span class="p">)),</span>
<span class="p">}</span>

</code></pre></div>
<blockquote>
<p>PrinterResponse structure</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="kd">data class</span> <span class="nc">PrinterResponse</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">status</span><span class="p">:</span> <span class="nc">Status</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">message</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">data</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">DocumentData</span><span class="p">&gt;,</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">enum</span> <span class="kd">class</span> <span class="nc">Status</span> <span class="p">{</span>
        <span class="nc">SUCCESS</span><span class="p">,</span>
        <span class="nc">ERROR</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h1 id='opit'>OPIT</h1>

<p>Odero POS Integration Toolkit for Developers<br/></p>

<p>Welcome to OPit, the Odero POS Integration Toolkit designed to streamline and enhance the communication between a Windows device (PC, laptop) and an Odero POS terminal. OPit enables developers to send commands such as Payment Requests, Settlements, Reports, and more, directly to the Odero POS terminal over a TCP/IP socket connection. By leveraging this powerful toolkit, developers can seamlessly integrate their Windows applications with Odero POS, unlocking new possibilities for efficient and secure payment processing.<br/></p>

<p>At its core, OPit provides a reliable and secure channel for data exchange between the Windows device and the Odero POS terminal. This communication is facilitated through TCP/IP sockets, allowing for real-time, bidirectional communication over a local network. To ensure a seamless connection, both the Windows device and the Odero POS terminal must be connected to the same router or Wi-Fi network.<br/></p>

<p>With OPit, developers gain full control over the payment flow, enabling them to initiate payment requests from their Windows applications and receive responses from the Odero POS terminal. This integration empowers developers to create custom workflows, tailor the user experience, and incorporate Odero POS functionality seamlessly into their existing applications. Whether you&#39;re building a point-of-sale system, a payment gateway, or any other payment-related application, OPit provides the tools you need to connect and communicate effortlessly with Odero POS.<br/></p>

<p>By leveraging the power of OPit, developers can harness the extensive capabilities of Odero POS, such as processing transactions, generating reports, performing settlements, and more, directly from their Windows applications. This seamless integration ensures a cohesive experience for users and eliminates the need for manual data entry or redundant workflows. With OPit, you can empower your users with a unified and efficient payment processing solution, offering a streamlined experience that enhances productivity and accuracy.<br/></p>

<p>In this developer documentation, we will provide you with comprehensive guidance on utilizing OPit to integrate your Windows applications with Odero POS. You&#39;ll find detailed instructions, sample code snippets, and best practices to help you make the most of this powerful toolkit. Whether you&#39;re a seasoned developer or just getting started, this documentation will serve as your roadmap to successfully integrating OPit and unlocking the full potential of Odero POS in your applications.<br/></p>

<p>We&#39;re excited to have you embark on this journey with OPit, and we look forward to witnessing the innovative solutions you&#39;ll build with the power of seamless communication between Windows devices and Odero POS terminals. Let&#39;s dive in and get started!<br/></p>

<h2 id='introduction'>Introduction</h2>

<p>OPit Lan for Windows is a C++ library which allows for a Windows device (PC, laptop) to send commands (Payment Request, Settlement, Reports etc) to an Odero Pos terminal.<br/>
The communication between the two devices is performed through TCP/IP sockets.<br/>
Both devices have to be connected to the same router / wifi network.</p>

<p>Please follow the below instructions for setup:<br/>
<ol type="1">
  <li>To use OPIT Lan you will need to use static ips for both devices, on the client tablet and the Odero POS terminal, and to have a dedicated router with - potentially - DHCP off (depends on the router)<br/>
Tutorial on how to set up static ip on Windows can be found <a href="https://pureinfotech.com/set-static-ip-address-windows-10">here</a>
</li>
  <li>Connect to wifi on the dedicated router on both devices.</li>
  <li>The Odero POS terminal must have the ip 192.168.1.1 this is the ip where the client device expects to find the host.</li>
  <li>Install app-lan-host-release.apk on the Odero POS terminal and OpitDesktopSampleApp on the Windows device.</li>
  <li>Start the OPIT Lan app on the Odero POS terminal.</li>
  <li>Start Sample app on windows.</li>
  <li>Send payment request.</li>
</ol></p>

<p><br/>
Below you can find the OPit Lan for Windows diagram.
<p align="center">
<img src="images/opit_lan_windows_diagram-08dd9580-08dd9580.jpeg" width=700></p></p>

<ol type="1">
  <li>OPit lan host on Odero POS terminal is started and the socket server is booted up.</li>
  <li>Client app (that implement OPit library) starts on windows device and connects to the socket server from the Odero POS terminal.</li>
  <li>Client app receives onConnected callback.</li>
  <li>Client app sends payment request via opened tcp/ip socket and is received on the Odero POS terminal.</li>
  <li>Client app terminates the socket connection.</li>
  <li>Client app receives onDisconnected callback.</li>
  <li>Odero POS terminal switchs from wifi to gsm data as required by the bank app in order to perform the transaction on secure connection. Also the host socket server is shut down.</li>
  <li>Odero POS terminal host awaits for response from the bank app.</li>
  <li>Client app sends connnection ping requests attempting to connect to the socket server on the host device. These attempts fail at this point because the socket server is shut down as described in previous step.</li>
  <li>Host app receives response from the bank app, network switch from gsm to wifi occurs and the socket server is started.</li>
  <li>Client app connection request is successful.</li>
  <li>Host app on Odero POS terminal sends the response from the bank app and is received on the client app (windows)</li>
</ol>

<p>The client app side implementation is rather simple, only step 4 is required to be perfomed, all other steps on the client side are performed under the hood inside the library.</p>

<h2 id='opit-setup'>Setup</h2>

<ol type="1">
  <li>Download the latest OPIT Lan for Windows <a href="https://github.com/OderoPos/opit-lan-windows/releases">release</a> and unzip the archive.</li>
  <li>Copy archive contents inside the sample project folder.</li>
  <li>Open the sample app project solution with Microsoft Visual Studio (make sure C++ module is installed).</li>
  <li>In Microsoft Visual Studio go to Project -> Properties -> C/C++ -> Command Line -> Additional Options -> add text: /std:c++latest
<p align="center"><img src="images/1-c57c7976-c57c7976.png" width=700></p>
  </li>
  <li>C/C++ -> General -> Additional Include Directories -> click on the dropdown -> Edit -> 
in the popup press the 3 dots (...) button from the right -> Choose headers folder from the opit-desktop project -> Ok
<p align="center"><img src="images/2a-f3a7b050-f3a7b050.png" width=700></p>
<p align="center"><img src="images/2b-e4d83d86-e4d83d86.png" width=700></p>
  </li>

  <li>Linker -> Input -> Additional Dependencies -> click on the dropdown -> Edit -> add text: OpitDesktop.lib -> Ok
<p align="center"><img src="images/3a-05caa5b3-05caa5b3.png" width=700></p>
<p align="center"><img src="images/3b-45cf7f51-45cf7f51.png" width=700></p>
</li>

  <li>Linker -> General -> Additional Library Directories -> click on the dropdown -> Edit -> 
in the popup press the 3 dots (...) button from the right -> select the folder where the OpitDesktop.lib file is located -> Ok
<p align="center"><img src="images/4a-d6d978e6-d6d978e6.png" width=700></p>
<p align="center"><img src="images/4b-5fcb9813-5fcb9813.png" width=700></p>
</li>

  <li>That's it! The solution should now build.</li>
</ol>
<h1 id='ecr-integration'>ECR integration</h1><h2 id='app-setup'>App Setup</h2>
<p>Login in ECR app with <code>integrator</code> user type.
A list with all the integrated apps on the ECR330 will be displayed.</p>

<p>If we want to mark an app as integrated with the ECR330 app we need to define in the manifest file of the target app the following metadata.</p>

<blockquote>
<p>AndroidManifest.xml</p>
</blockquote>
<div class="highlight"><pre class="highlight xml tab-xml"><code><span class="nt">&lt;meta-data</span>
    <span class="na">android:name=</span><span class="s">"app_name"</span>
    <span class="na">android:value=</span><span class="s">"ECR_[app name]"</span> <span class="nt">/&gt;</span>
</code></pre></div>
<p>After that, the app will be displayed on the main screen of the ECR330 app.</p>
<h2 id='fiscal-commands'>Fiscal commands</h2>
<p>libVersion = Check latest version <a href="https://ro-artifactory.devtokeninc.com/ui/native/PublicLibraries/X330/integrationLibs/fiscal">here</a></p>

<p><strong><em>NOTE:</em></strong>  For best compatibility <code>libVersion</code> should match ECR version installed</p>

<blockquote>
<p>Dependencies</p>
</blockquote>
<div class="highlight"><pre class="highlight groovy tab-groovy"><code><span class="c1">//in settings.gradle</span>
<span class="n">maven</span> <span class="o">{</span>
    <span class="n">url</span> <span class="s1">'https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/'</span>
<span class="o">}</span>

<span class="c1">//in app.gradle</span>
<span class="n">implementation</span> <span class="err">'</span><span class="n">X330</span><span class="o">.</span><span class="na">integrationLibs</span><span class="o">:</span><span class="nl">fiscal:</span><span class="n">$libVersion</span>
</code></pre></div>
<p>Use <code>EcrCommandExecutor</code> object for sending commands to the ECR and receiving the result.</p>

<p>The fiscal commands are sent to the ECR using the <code>executeFiscalCommand</code> method. The result can be received
as a <code>Flow</code> or if you want to receive as a <code>EcrCommandResultListener</code>.</p>

<p>The user screen commands follow the same <code>flow</code>, <code>listener</code> pattern.</p>

<p>Type of fiscal commands</p>

<p><code>SetDateTime</code><br>
<code>SetCompanyData</code><br>
<code>GetCompanyData</code><br>
<code>SetVATRates</code><br>
<code>GetVATRates</code><br>
<code>Fiscalise</code><br>
<code>InitElectronicJournal</code><br>
<code>TechnicalReport</code><br>
<code>ZReport</code><br>
<code>XReport</code><br>
<code>InitJournal</code><br>
<code>Journal</code><br>
<code>JournalExport</code><br>
<code>XJournal</code><br>
<code>CustomerData</code><br>
<code>PeriodicReport</code><br>
    - <code>ByDate</code><br>
    - <code>ByZ</code><br>
<code>XMLReport</code><br>
<code>GetDailyTotals</code><br>
<code>GetStatus</code><br>
<code>GetSoftwareVersion</code><br>
<code>LoadProfile</code><br>
<code>ResetFiscalMemory</code><br>
<code>Sale</code><br>
<code>CashOperation</code>  </p>

<blockquote>
<p>Fiscal commands</p>
</blockquote>
<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code><span class="c1">//Example of usage for sending a fiscal command and receiving the result as a [Flow]:</span>
<span class="nc">EcrCommandExecutor</span><span class="p">.</span><span class="nf">executeFiscalCommand</span><span class="p">(</span>
   <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
   <span class="n">command</span> <span class="p">=</span> <span class="nc">FiscalCommand</span><span class="p">.</span><span class="nc">SetDateTime</span><span class="p">(</span><span class="nc">Calendar</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="n">time</span><span class="p">),</span>
<span class="p">).</span><span class="nf">collect</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span>
    <span class="n">result</span><span class="p">.</span><span class="nf">runCatching</span> <span class="p">{</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"MainActivity"</span><span class="p">,</span> <span class="s">"Result.Success: $result"</span><span class="p">)</span>
        <span class="nc">Toast</span><span class="p">.</span><span class="nf">makeText</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="nc">Toast</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="p">}.</span><span class="nf">onFailure</span> <span class="p">{</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">e</span><span class="p">(</span><span class="s">"MainActivity"</span><span class="p">,</span> <span class="s">"Result.Failure: $result"</span><span class="p">)</span>
        <span class="nc">Toast</span><span class="p">.</span><span class="nf">makeText</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="nc">Toast</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
     <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Example of usage for sending a fiscal command and receiving the result as a [EcrCommandResultListener]:</span>
<span class="nc">EcrCommandExecutor</span><span class="p">.</span><span class="nf">executeFiscalCommand</span><span class="p">(</span>
   <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
   <span class="n">command</span> <span class="p">=</span> <span class="nc">FiscalCommand</span><span class="p">.</span><span class="nc">SetDateTime</span><span class="p">(</span><span class="nc">Calendar</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">().</span><span class="n">time</span><span class="p">),</span>
   <span class="n">listener</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">EcrCommandResultListener</span> <span class="p">{</span>
         <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEcrCommandResult</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">// Handle the successful result</span>
         <span class="p">}</span>
         <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEcrCommandError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">// Handle the error result</span>
         <span class="p">}</span>
   <span class="p">},</span>
<span class="p">)</span>

<span class="c1">//Example of usage for sending a user screen command and receiving the result as a [Flow]:</span>
<span class="nc">EcrCommandExecutor</span><span class="p">.</span><span class="nf">executeUserScreenCommand</span><span class="p">(</span>
   <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
   <span class="n">newText</span> <span class="p">=</span> <span class="nc">SecureRandom</span><span class="p">().</span><span class="nf">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">toString</span><span class="p">(),</span>
<span class="p">).</span><span class="nf">collect</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span>
    <span class="n">result</span><span class="p">.</span><span class="nf">runCatching</span> <span class="p">{</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"MainActivity"</span><span class="p">,</span> <span class="s">"Result.Success: $result"</span><span class="p">)</span>
        <span class="nc">Toast</span><span class="p">.</span><span class="nf">makeText</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="nc">Toast</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="p">}.</span><span class="nf">onFailure</span> <span class="p">{</span>
        <span class="nc">Log</span><span class="p">.</span><span class="nf">e</span><span class="p">(</span><span class="s">"MainActivity"</span><span class="p">,</span> <span class="s">"Result.Failure: $result"</span><span class="p">)</span>
        <span class="nc">Toast</span><span class="p">.</span><span class="nf">makeText</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="nc">Toast</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Example of usage for sending a user screen command and receiving the result as a [EcrCommandResultListener]:</span>
<span class="nc">EcrCommandExecutor</span><span class="p">.</span><span class="nf">executeUserScreenCommand</span><span class="p">(</span>
   <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
   <span class="n">newText</span> <span class="p">=</span> <span class="nc">SecureRandom</span><span class="p">().</span><span class="nf">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">toString</span><span class="p">(),</span>
   <span class="n">listener</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">EcrCommandResultListener</span> <span class="p">{</span>
       <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEcrCommandResult</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
           <span class="c1">// Handle the successful result</span>
       <span class="p">}</span>
       <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEcrCommandError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
           <span class="c1">// Handle the error result</span>
       <span class="p">}</span>
   <span class="p">},</span>
<span class="p">)</span>

<span class="c1">//Example of a sale fiscal command</span>
<span class="nc">FiscalCommand</span><span class="p">.</span><span class="nc">Sale</span><span class="p">(</span>
    <span class="n">sellerInfo</span> <span class="p">=</span> <span class="nc">SellerInfo</span><span class="p">(</span>
        <span class="n">cashierName</span> <span class="p">=</span> <span class="s">"John Doe"</span><span class="p">,</span>
        <span class="n">posNumber</span> <span class="p">=</span> <span class="s">"123413"</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">products</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
        <span class="nc">FiscalProduct</span><span class="p">(</span>
            <span class="n">productName</span> <span class="p">=</span> <span class="s">"Product 1"</span><span class="p">,</span>
            <span class="n">unit</span> <span class="p">=</span> <span class="s">"kg"</span><span class="p">,</span>
            <span class="n">quantity</span> <span class="p">=</span> <span class="s">"1"</span><span class="p">,</span>
            <span class="n">pricePerUnit</span> <span class="p">=</span> <span class="s">"10,5"</span><span class="p">,</span>
            <span class="n">vatId</span> <span class="p">=</span> <span class="s">"B"</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="nc">FiscalProduct</span><span class="p">(</span>
            <span class="n">productName</span> <span class="p">=</span> <span class="s">"Product 2"</span><span class="p">,</span>
            <span class="n">unit</span> <span class="p">=</span> <span class="s">"kg"</span><span class="p">,</span>
            <span class="n">quantity</span> <span class="p">=</span> <span class="s">"1"</span><span class="p">,</span>
            <span class="n">pricePerUnit</span> <span class="p">=</span> <span class="s">"15,5"</span><span class="p">,</span>
            <span class="n">vatId</span> <span class="p">=</span> <span class="s">"B"</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="n">payments</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
        <span class="nc">FiscalPayment</span><span class="p">(</span>
            <span class="n">paymentMethod</span> <span class="p">=</span> <span class="nc">FiscalPayment</span><span class="p">.</span><span class="nc">PaymentMethod</span><span class="p">.</span><span class="nc">Card</span><span class="p">,</span>
            <span class="n">amount</span> <span class="p">=</span> <span class="s">"26"</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="n">cifNumber</span> <span class="p">=</span> <span class="s">"43511483"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div><h2 id='sending-a-card-payment'>Sending a card payment</h2>
<p>Please check out <a href="https://developer.pos.odero.ro/#paymentgateway">PaymentGateway</a> docs</p>

<h1 id='in-app-payments'>In App Payments</h1>
<p>The Odero In App Payments SDK enables secure and seamless payment processing directly within your application. This comprehensive SDK provides enterprise-grade tools and APIs for handling various payment scenarios while maintaining the highest standards of security and reliability.</p>

<h2 id='sdk-setup'>SDK Setup</h2>
<p>The SDK supports integration with iOS, Android, and React Native platforms. Follow the platform-specific installation and configuration instructions below.</p>

<div class="platform-buttons" style="margin: 20px 0; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; padding-left: 28px;">
  <button id="ios-btn" class="platform-btn" style="padding: 10px 20px; margin-right: 5px; background-color: #2E3336; color: white; border: none; border-radius: 3px 3px 3px 3px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">iOS</button>
  <button id="android-btn" class="platform-btn" style="padding: 10px 20px; margin-right: 5px; background-color: #2E3336; color: white; border: none; border-radius: 3px 3px 3px 3px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Android</button>
  <button id="react-native-btn" class="platform-btn" style="padding: 10px 20px; background-color: #2E3336; color: white; border: none; border-radius: 3px 3px 3px 3px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">React Native</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get the buttons
    const iosBtn = document.getElementById('ios-btn');
    const androidBtn = document.getElementById('android-btn');
    const reactNativeBtn = document.getElementById('react-native-btn');
    
    // Get the sections
    const iosSection = document.getElementById('ios-setup');
    const androidSection = document.getElementById('android-setup');
    const reactNativeSection = document.getElementById('react-native-setup');
    
    // Get all elements between sections
    function getElementsBetween(startId, endId) {
      const elements = [];
      let current = document.getElementById(startId);
      const end = document.getElementById(endId);
      
      elements.push(current); // Include the start element
      
      while (current && current.nextElementSibling && current.nextElementSibling !== end) {
        current = current.nextElementSibling;
        elements.push(current);
      }
      
      return elements;
    }
    
    // Get React Native elements (special case for the last section)
    function getReactNativeElements() {
      const elements = [];
      let current = document.getElementById('react-native-setup');
      
      elements.push(current); // Include the start element
      
      // Continue until we reach the .dark-box or .content end
      while (current && current.nextElementSibling && 
             !current.nextElementSibling.classList.contains('dark-box') &&
             current.parentElement && current.nextElementSibling.parentElement === current.parentElement) {
        current = current.nextElementSibling;
        elements.push(current);
      }
      
      return elements;
    }
    
    // Get all elements for each section
    const iosElements = getElementsBetween('ios-setup', 'android-setup');
    const androidElements = getElementsBetween('android-setup', 'react-native-setup');
    const reactNativeElements = getReactNativeElements();
    
    // Function to hide elements
    function hideElements(elements) {
      elements.forEach(el => {
        if (el) el.style.display = 'none';
      });
    }
    
    // Function to show elements
    function showElements(elements) {
      elements.forEach(el => {
        if (el) el.style.display = '';
      });
    }
    
    // Function to hide all sections
    function hideAllSections() {
      hideElements(iosElements);
      hideElements(androidElements);
      hideElements(reactNativeElements);
    }
    
    // Initialize with iOS section visible
    hideAllSections();
    showElements(iosElements);
    iosBtn.style.opacity = '1';
    androidBtn.style.opacity = '0.7';
    reactNativeBtn.style.opacity = '0.7';
    
    // Add click event listeners
    iosBtn.addEventListener('click', function() {
      hideAllSections();
      showElements(iosElements);
      iosBtn.style.opacity = '1';
      androidBtn.style.opacity = '0.7';
      reactNativeBtn.style.opacity = '0.7';
    });
    
    androidBtn.addEventListener('click', function() {
      hideAllSections();
      showElements(androidElements);
      iosBtn.style.opacity = '0.7';
      androidBtn.style.opacity = '1';
      reactNativeBtn.style.opacity = '0.7';
    });
    
    reactNativeBtn.addEventListener('click', function() {
      hideAllSections();
      showElements(reactNativeElements);
      iosBtn.style.opacity = '0.7';
      androidBtn.style.opacity = '0.7';
      reactNativeBtn.style.opacity = '1';
    });
    
    // Add hover effect
    const buttons = [iosBtn, androidBtn, reactNativeBtn];
    buttons.forEach(btn => {
      btn.addEventListener('mouseenter', function() {
        if (this.style.opacity !== '1') {
          this.style.opacity = '0.9';
        }
      });
      
      btn.addEventListener('mouseleave', function() {
        if (this.style.opacity !== '1') {
          this.style.opacity = '0.7';
        }
      });
    });
  });
</script>

<h3 id='ios-setup'>iOS Integration</h3>

<blockquote>
<p>Add to Podfile</p>
</blockquote>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code><span class="c1"># Uncomment the next line to define a global platform for your project</span>
<span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'13.0'</span>

<span class="n">target</span> <span class="s1">'YourApp'</span> <span class="k">do</span>
  <span class="c1"># Comment the next line if you don't want to use dynamic frameworks</span>
  <span class="n">use_frameworks!</span>

  <span class="c1"># Pods for YourApp</span>
  <span class="n">pod</span> <span class="s1">'OderoPaySDKIOS'</span><span class="p">,</span> <span class="ss">:podspec</span> <span class="o">=></span> <span class="s1">'https://raw.githubusercontent.com/OderoPos/react-odero-mobilesdk/main/OderoPaySDKIOS/0.1.4/OderoPaySDKIOS.podspec'</span>
<span class="k">end</span></code></pre></div>

<p>Configure your iOS project by adding the Odero Pay SDK dependency using CocoaPods.</p>

<h4>Prerequisites</h4>
<ul>
  <li>Xcode 14.0 or later</li>
  <li>iOS 13.0 or later</li>
  <li>CocoaPods 1.10.0 or later</li>
</ul>

<p>After adding the pod dependency shown in the right section, execute <code>pod install</code> command in your terminal.</p>

<p>After installation, always open the <code>.xcworkspace</code> file instead of the <code>.xcodeproj</code> file to work with your project.</p>

<h3 id='android-setup'>Android Integration</h3>

<blockquote>
  <p>Step 1: Add the Maven Repository in <strong>settings.gradle</strong> of your app</p>
</blockquote>

<div class="highlight">
  <pre style="background-color: #000000; color: #d4d4d4; font-size: 12px;"><code class="language-kotlin">
pluginManagement {
    repositories {
        google()
        mavenCentral()
        maven {
            url = uri("https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/")
        }
    }
}

dependencyResolutionManagement {
    repositories {
        google()
        mavenCentral()
        maven {
            url = uri("https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/")
        }
    }
}
  </code></pre>
</div>

<blockquote>
<p>Step 2: Declare the Dependency</p>
</blockquote>
<div class="highlight"><pre style="background-color: #000000; color: #d4d4d4; font-size: 12px;"><code class="language-kotlin">
dependencies {
  implementation 'Odero.oderopaysdk:oderopaysdkandroid:0.0.1'
}
  </code></pre>
</div>

<blockquote>
<p>Step 3: Sync Project</p>
</blockquote>
<div class="highlight"><pre style="background-color: #000000; color: #d4d4d4; font-size: 12px;" class="highlight shell tab-shell"><code>File > Sync Project with Gradle Files

# Or in terminal:
gradle build</code></pre></div>

<p>Configure your Android project by adding the Odero Pay SDK dependency using Gradle.</p>

<h4>Prerequisites</h4>
<ul>
  <li>Android Studio Arctic Fox or later</li>
  <li>Minimum SDK version 21</li>
  <li>Gradle version 7.0 or later</li>
</ul>

<h3 id='react-native-setup'>React Native Integration</h3>

<h4>Prerequisites</h4>
<ul>
  <li>React Native 0.63.0 or later</li>
  <li>Node.js 14 or later</li>
  <li>Xcode 14.0 or later (for iOS)</li>
  <li>Android Studio Arctic Fox or later (for Android)</li>
  <li>CocoaPods 1.10.0 or later (for iOS)</li>
</ul>

<p>After completing these steps, the Odero Pay SDK will be integrated into your React Native application and ready to import.</p>
<p>import {OderoMobilesdk} from 'react-native-odero-pay-sdk'</p>


<blockquote>
<p><strong>Step 1: Create React Native Application</strong></p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>npx @react-native-community/cli init TestReactOderoInApp</code></pre></div>

<blockquote>
  <p><strong>Step 2: Create Native Module Library</strong></p>
  <p>Run the following command to create the native module library in the project root directory:</p>
</blockquote>

<div class="highlight"><pre class="highlight shell tab-shell"><code>npx create-react-native-library@latest odero-pay-sdk</code></pre></div>

<div class="terminal">
  <pre>
For this example, we will use odero-pay-sdk as our library name. After executing the command, you will be prompted with several options:

 Looks like you're under a project folder. Do you want to create a local library?  yes
 Where do you want to create the library?  modules/odero-pay-sdk
 What is the name of the npm package?  react-native-odero-pay-sdk
 What is the description for the package?  odero-pay-sdk
 What type of library do you want to develop?  Legacy Native Module
 Which languages do you want to use?  Kotlin & Swift
 Project created successfully at modules/odero-pay-sdk!
  </pre>
</div>


<blockquote>
  <p><strong>Step 3: Configure Android Dependencies</strong></p>
  <p># In modules/odero-pay-sdk/android/build.gradle</p>
</blockquote>
<div class="highlight"><pre class="highlight groovy tab-groovy"><code>repositories {
    mavenCentral()
    google()
    maven {
        url 'https://ro-artifactory.devtokeninc.com/artifactory/PublicLibraries/'
    }
}

dependencies {
    implementation "Odero.oderopaysdk:oderopaysdkandroid:0.0.1"
}</code></pre></div>

<blockquote>
  <p><strong>Step 4: Configure iOS Dependencies</strong></p>
  <p># In ios/Podfile</p>
</blockquote>

<div class="highlight"><pre class="highlight ruby tab-ruby"><code>pod 'OderoPaySDKIOS', :podspec => 'https://raw.githubusercontent.com/OderoPos/react-odero-mobilesdk/main/OderoPaySDKIOS/0.1.4/OderoPaySDKIOS.podspec'</code></pre></div>

<blockquote>
  <p># In modules/odero-pay-sdk/OderoPaySdk.podspec</p>
</blockquote>
<div class="highlight"><pre class="highlight ruby tab-ruby"><code>s.dependency "OderoPaySDKIOS", "0.1.4"</code></pre></div>

<blockquote>
  <p><strong>Step 5: Export the Module</strong></p>
  <p># In modules/odero-pay-sdk/src/index.tsx</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code>module.exports = { OderoPaySdk };</code></pre></div>

<blockquote>
  <p><strong>Step 6: Implement Native Bridge Code</strong></p>
  <p>Now we will setup bridging code, this way we will be able to use native code (swift and kotlin) in javascript</p>
  <p><strong>Android</strong></p>
  <p> In OderoPaySdkModule.kt</p>
  <p># modules/odero-pay-sdk/android/src/main/java/com/oderopaysdk/OderoPaySdkModule.kt</p>
</blockquote>

<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code>package com.oderopaysdk

import android.app.Activity
import android.content.Intent
import android.graphics.Color
import androidx.core.graphics.toColor
import com.facebook.react.bridge.Arguments
import com.facebook.react.bridge.BaseActivityEventListener
import com.facebook.react.bridge.ReactApplicationContext
import com.facebook.react.bridge.ReactContextBaseJavaModule
import com.facebook.react.bridge.ReactMethod
import com.facebook.react.bridge.ReadableMap
import com.facebook.react.bridge.WritableNativeMap
import com.facebook.react.modules.core.DeviceEventManagerModule
import com.oderopaysdk.OderoPaySdk
import com.oderopaysdk.PaymentCallback
import com.oderopaysdk.appearance.BillingInformation
import com.oderopaysdk.appearance.CardDetails
import com.oderopaysdk.appearance.CardMeta
import com.oderopaysdk.appearance.Field
import com.oderopaysdk.appearance.PaymentButton
import com.oderopaysdk.appearance.PaymentInfo

class OderoPaySdkModule(private val reactContext: ReactApplicationContext) :
    ReactContextBaseJavaModule(reactContext) {
    private val LOAD_PAYMENT_DATA_REQUEST_CODE = 101
    private val SCREEN_3DS_REQUEST_CODE = 102

    private val OderoPaySdk by lazy {
        currentActivity?.let {
            OderoPaySdk(
                it,
                LOAD_PAYMENT_DATA_REQUEST_CODE,
                SCREEN_3DS_REQUEST_CODE
            )
        }
    }
    private var eventEmitter: DeviceEventManagerModule.RCTDeviceEventEmitter? = null

    init {
        reactContext.addActivityEventListener(object : BaseActivityEventListener() {
            override fun onActivityResult(
                activity: Activity,
                requestCode: Int,
                resultCode: Int,
                intent: Intent?
            ) {
                when (requestCode) {
                    LOAD_PAYMENT_DATA_REQUEST_CODE -> {
                        OderoPaySdk?.handleGooglePayActivityResult(resultCode, intent)
                    }

                    SCREEN_3DS_REQUEST_CODE -> {
                        OderoPaySdk?.handle3DSScreenActivityResult(resultCode, intent)
                    }
                }
            }
        })
    }

    override fun initialize() {
        eventEmitter =
            reactContext.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)
        super.initialize()
    }

    override fun getName(): String {
        return NAME
    }

    @ReactMethod
    fun addListener(eventName: String) {
        OderoPaySdk?.addListener(object : PaymentCallback {
            override fun receiveError(
                errorString: String?,
                message: String?,
                detailedMessage: String?
            ) {
                sendEvent(
                    eventName, errorString = errorString,
                    message = message, detailedMessage = detailedMessage
                )
            }

            override fun receiveStatus(result: String) {
                sendEvent(eventName, status = result)
            }
        })
    }

    private fun sendEvent(
        eventName: String,
        status: String? = null,
        errorString: String? = null,
        message: String? = null,
        detailedMessage: String? = null
    ) {
        val params = Arguments.createMap().apply {
            status?.let {
                putString("status", status)
            }
            errorString?.let {
                message?.let {
                    detailedMessage?.let {
                        putMap("error", WritableNativeMap().apply {
                            putString("errorString", errorString)
                            putString("message", message)
                            putString("detailedMessage", detailedMessage)
                        })
                    }
                }
            }
        }
        eventEmitter?.emit(eventName, params)
    }


    @ReactMethod
    fun removeListeners() {
        OderoPaySdk?.removeListeners()
    }

    @ReactMethod
    fun closePaymentSheet() {
        OderoPaySdk?.closePaymentSheet()
    }

    @ReactMethod
    @JvmOverloads
    fun showPaymentSheet(
        sessionId: String,
        appearance: ReadableMap,
        applePayMerchant: String? = null
    ) {
        OderoPaySdk?.let { sdk ->
            val background = appearance.getString("background")?.let {
                Color.parseColor(it).toColor()
            }
            val borderWidth = appearance.getInt("borderWidth")
            val borderColor =
                appearance.getString("borderColor")?.let { Color.parseColor(it).toColor() }
            val cardDetails = getCardDetails(appearance)
            val billingInformation = getBillingInformation(appearance)

            val paymentInfo =
                PaymentInfo(background, borderWidth, borderColor, cardDetails, billingInformation)
            sdk.showPaymentSheet(sessionId, paymentInfo)
        }
    }

    private fun getBillingInformation(appearance: ReadableMap?): BillingInformation? {
        return appearance?.getMap("billingInformationComponent")?.let { billing ->
            BillingInformation(
                billing.getString("title"),
                billing.getInt("titleSize"),
                billing.getString("titleColor")?.let { Color.parseColor(it).toColor() },
                getField(billing.getMap("email")),
                getField(billing.getMap("phone")),
                getField(billing.getMap("country")),
                getField(billing.getMap("city")),
                getField(billing.getMap("address"))
            )
        }
    }

    private fun getCardDetails(appearance: ReadableMap?): CardDetails? {
        return appearance?.getMap("cardDetailsComponent")?.let { cardDetails ->
            CardDetails(
                cardDetails.getString("title"),
                cardDetails.getInt("titleSize"),
                cardDetails.getString("titleColor")?.let { Color.parseColor(it).toColor() },
                getField(cardDetails.getMap("cardNumber")),
                getField(cardDetails.getMap("expirationDate")),
                getField(cardDetails.getMap("securityCode")),
                getField(cardDetails.getMap("cardHolder")),
                cardDetails.getMap("saveCard")?.let { cardMeta ->
                    CardMeta(
                        cardMeta.getString("color")?.let { Color.parseColor(it).toColor() },
                        cardMeta.getString("title"),
                        cardMeta.getInt("titleSize"),
                        cardMeta.getString("titleColor")?.let { Color.parseColor(it).toColor() }
                    )
                },
                cardDetails.getMap("paymentButton")?.let { paymentButton ->
                    PaymentButton(
                        paymentButton.getString("title")
                    )
                }
            )
        }
    }

    private fun getField(appearance: ReadableMap?): Field? {
        return appearance?.let {
            Field(
                it.getString("hint"),
                it.getInt("hintSize"),
                it.getString("hintError"),
                it.getString("hintColor")?.let { Color.parseColor(it).toColor() }
            )
        }
    }

    companion object {
        const val NAME = "OderoPaySdk"
    }
}
</code></pre></div>

<blockquote>
  <p> In OderoPaySdkPackage.kt</p>
  <p># modules/odero-pay-sdk/android/src/main/java/com/oderopaysdk/OderoPaySdkPackage.kt</p>
</blockquote>

<div class="highlight"><pre class="highlight kotlin tab-kotlin"><code>class OderoPaySdkPackage : ReactPackage {
    override fun createNativeModules(reactContext: ReactApplicationContext): List<NativeModule> {
        return listOf(OderoPaySdkModule(reactContext))
    }

    override fun createViewManagers(reactContext: ReactApplicationContext): List<ViewManager<*, *>> {
        return listOf()
    }
}
</code></pre></div>

<blockquote>
  <p><strong>IOS</strong></p>
  <p> In OderoPaySdk.mm</p>
  <p># modules/odero-pay-sdk/ios/OderoPaySdk.mm</p>
</blockquote>

<div class="highlight"><pre class="highlight objectivec tab-objectivec"><code>#import &lt;React/RCTBridgeModule.h&gt;
#import &lt;React/RCTEventEmitter.h&gt;

@interface RCT_EXTERN_MODULE(OderoPaySdk, RCTEventEmitter)

RCT_EXTERN_METHOD(showPaymentSheet:(NSString *)sessionId
        appearance:(NSDictionary *)appearance
        applePayMerchantId:(NSString *)applePayMerchantId)

RCT_EXTERN_METHOD(closePaymentSheet)

+ (BOOL)requiresMainQueueSetup
{
    return YES;
}

@end</code></pre></div>

<blockquote>
  <p> In OderoPaySdk-Bridging-Header.h</p>
  <p># modules/odero-pay-sdk/ios/OderoPaySdk-Bridging-Header.h</p>
</blockquote>
  
<div class="highlight"><pre class="highlight objectivec tab-objectivec"><code>#import &lt;React/RCTBridgeModule.h&gt;
#import &lt;React/RCTViewManager.h&gt;</code></pre></div>

<blockquote>
  <p> In OderoPaySdk.swift</p>
  <p># modules/odero-pay-sdk/ios/OderoPaySdk.swift</p>
</blockquote>

<div class="highlight"><pre class="highlight objectivec tab-objectivec"><code>import Foundation
import React
import OderoPaySDKIOS

@objc(OderoPaySdk)
class OderoPaySdk: RCTEventEmitter {
    private let oderoPaySDK = OderoPaySDK()
    private var hasListeners = false

    override init() {
        super.init()
        // Observe the PaymentEvent from NotificationCenter
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(handlePaymentEvent(_:)),
            name: Notification.Name("PaymentEvent"),
            object: nil
        )
    }

    deinit {
        NotificationCenter.default.removeObserver(self)
    }

    override func supportedEvents() -> [String]! {
        return ["PaymentEvent"]
    }

    override func startObserving() {
        hasListeners = true
    }

    override func stopObserving() {
        hasListeners = false
    }

    @objc private func handlePaymentEvent(_ notification: Notification) {
        guard hasListeners else {
            print("No listeners registered for PaymentEvent")
            return
        }
        guard let userInfo = notification.userInfo else {
            print("No userInfo found in PaymentEvent notification")
            return
        }
        sendEvent(withName: "PaymentEvent", body: userInfo)
    }

    @objc func showPaymentSheet(_ sessionId: String, appearance: NSDictionary, applePayMerchantId: String?) {
        DispatchQueue.main.async {
            let paymentAppearance = self.parseAppearance(from: appearance)
            self.oderoPaySDK.showPaymentSheet(
                sessionId: sessionId,
                appearance: paymentAppearance,
                applePayMerchantId: applePayMerchantId ?? ""
            )
        }
    }

    @objc func closePaymentSheet() {
        DispatchQueue.main.async {
            self.oderoPaySDK.closePaymentSheet()
        }
    }

    private func parseAppearance(from dictionary: NSDictionary) -> PaymentAppearance {
        return PaymentAppearance(
            background: dictionary["background"] as? String,
            borderWidth: dictionary["borderWidth"] as? String,
            borderColor: dictionary["borderColor"] as? String,
            cardDetailsComponent: parseCardDetails(from: dictionary["cardDetailsComponent"] as? NSDictionary),
            billingInformationComponent: parseBillingInformation(from: dictionary["billingInformationComponent"] as? NSDictionary)
        )
    }

    private func parseCardDetails(from dictionary: NSDictionary?) -> PaymentAppearance.CardDetailsComponent? {
        guard let dict = dictionary else { return nil }
        return PaymentAppearance.CardDetailsComponent(
            title: dict["title"] as? String,
            titleSize: dict["titleSize"] as? String,
            titleColor: dict["titleColor"] as? String,
            cardNumber: parseField(from: dict["cardNumber"] as? NSDictionary),
            expirationDate: parseField(from: dict["expirationDate"] as? NSDictionary),
            securityCode: parseField(from: dict["securityCode"] as? NSDictionary),
            cardHolder: parseField(from: dict["cardHolder"] as? NSDictionary),
            saveCard: parseSaveCard(from: dict["saveCard"] as? NSDictionary),
            paymentButton: parsePaymentButton(from: dict["paymentButton"] as? NSDictionary)
        )
    }

    private func parseBillingInformation(from dictionary: NSDictionary?) -> PaymentAppearance.BillingInformationComponent? {
        guard let dict = dictionary else { return nil }
        return PaymentAppearance.BillingInformationComponent(
            title: dict["title"] as? String,
            titleSize: dict["titleSize"] as? String,
            titleColor: dict["titleColor"] as? String,
            email: parseField(from: dict["email"] as? NSDictionary),
            phone: parseField(from: dict["phone"] as? NSDictionary),
            country: parseField(from: dict["country"] as? NSDictionary),
            city: parseField(from: dict["city"] as? NSDictionary),
            address: parseField(from: dict["address"] as? NSDictionary)
        )
    }

    private func parseField(from dictionary: NSDictionary?) -> PaymentAppearance.Field? {
        guard let dict = dictionary else { return nil }
        return PaymentAppearance.Field(
            hint: dict["hint"] as? String,
            hintSize: dict["hintSize"] as? String,
            hintError: dict["hintError"] as? String,
            hintColor: dict["hintColor"] as? String
        )
    }

    private func parseSaveCard(from dictionary: NSDictionary?) -> PaymentAppearance.SaveCard? {
        guard let dict = dictionary else { return nil }
        return PaymentAppearance.SaveCard(
            color: dict["color"] as? String,
            title: dict["title"] as? String,
            titleSize: dict["titleSize"] as? String,
            titleColor: dict["titleColor"] as? String
        )
    }

    private func parsePaymentButton(from dictionary: NSDictionary?) -> PaymentAppearance.PaymentButton? {
        guard let dict = dictionary else { return nil }
        return PaymentAppearance.PaymentButton(
            title: dict["title"] as? String
        )
    }
}
</code></pre></div>
  

<blockquote>
  <p><strong>7: Install Dependencies</strong></p>
  <p># Install project dependencies in the root directory</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>yarn install</code></pre></div>

<blockquote>
  <p><strong>Step 8: Link Native Module</strong></p>
  <p>Run following command in modules/odero-pay-sdk</p>
</blockquote>
  <div class="highlight"><pre class="highlight shell tab-shell"><code>yarn link</code></pre></div>

<blockquote>
  <p><strong>9: Link Native Module in the Root Directory</strong></p>
</blockquote>
  <div class="highlight"><pre class="highlight shell tab-shell"><code>yarn link "react-native-odero-pay-sdk"</code></pre></div>

<blockquote>
  <p><strong>10: Pod Install</strong></p>
  <p>Run following command in ios directory</p>
</blockquote>
  <div class="highlight"><pre class="highlight shell tab-shell"><code>pod install</code></pre></div>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
  <script>
    // Ensure Prism.js is initialized
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
      }
    });
  </script>
</html>
